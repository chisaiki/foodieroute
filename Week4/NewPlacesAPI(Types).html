<!DOCTYPE html>
<html>
  <head>
    <title>Places API Test</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=APIKEY&libraries=places&callback=initMap" async defer></script>
    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      let map;
      // Initial map setup
      const ORIGIN = { lat: 40.7648, lng: -73.9654 }; // Hunter College
      const RADIUS = 500; // in meters
      const SEARCH_QUERY = "Pizza"; // Searching for Pizza places
      const MAX_RESULT = 10; //max number of places shown per circle 

      function initMap() { 

        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: ORIGIN,
        });

        // Coordinates to perform nearbySearch on
        const coords = [
          [40.76507, -73.96520000000001],  // Index 0
          [40.76205, -73.9633],             // Index 5
          [40.75864000000001, -73.96579000000001], // Index 10
          [40.75175, -73.97081],           // Index 15
          [40.74443, -73.97614],           // Index 20
          [40.744730000000004, -73.98163000000001], // Index 25
          [40.749590000000005, -73.99317]  // Index 30
        ];

        // Initialize PlacesService
        const service = new google.maps.places.PlacesService(map);

        // Iterate over the coords array and perform nearbySearch for each coordinate
        for (let j = 0; j < coords.length; j++) {
          let POINT = { lat: coords[j][0], lng: coords[j][1] };
          
          // Add a marker for each point
          new google.maps.Marker({
            position: POINT,
            map: map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: "blue", // Blue color for the marker
              fillOpacity: 1,
              strokeColor: "blue",
              strokeOpacity: 1,
              strokeWeight: 2,
              scale: 6,
            }
          });

          // Draw a transparent circle with the specified radius around each point
          new google.maps.Circle({
            map: map,
            center: POINT,
            radius: RADIUS, // Radius in meters
            fillColor: "#0000FF", // Semi-transparent blue
            fillOpacity: 0.1,
            strokeColor: "#0000FF", // Blue circle border
            strokeOpacity: 0.5,
            strokeWeight: 1,
          });

          // Perform nearby search for each coord
          fetchNearbyPlaces(POINT);
        }
      }


      // Function to make the API request
      function fetchNearbyPlaces(location) {
        const url = `https://places.googleapis.com/v1/places:searchNearby?key=APIKEY`;

        const body = {
          "locationRestriction": {
            "circle": {
              "center": {
                "latitude": location.lat,    // Use 'latitude' instead of 'lat'
                "longitude": location.lng    // Use 'longitude' instead of 'lng'
              },
              "radius": RADIUS
            }
          },
          "includedTypes": ["restaurant"], // Example: Search for restaurants
          "maxResultCount": MAX_RESULT
        };

        console.log('Request URL:', url);
        console.log('Request Body:', JSON.stringify(body));

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-FieldMask': 'places.displayName,places.location' // Request the location field as well
          },
          body: JSON.stringify(body)
        })
        .then(response => response.json())
        .then(data => {
          // Log the response to the console for debugging
          console.log('API Response:', data);

          // Check if places are returned
          if (data && data.places) {
            console.log('Places Found:', data.places);

            // Loop through each place
            data.places.forEach(place => {
              // Log the location data for debugging
              console.log('Place location:', place.location);

              // Ensure that each place has a valid location and name
              if (place.location && place.location.latitude && place.location.longitude) {
                // Create a marker for each place
                new google.maps.Marker({
                  position: {
                    lat: place.location.latitude,
                    lng: place.location.longitude
                  }, // Use the latitude and longitude directly
                  map: map,
                  title: place.displayName.text // Use the place's display name as the title
                });
              } else {
                console.log('Invalid location for place:', place);
              }
            });
          } else {
            console.log('No places found or error in response:', data);
          }
        })
        .catch(error => {
          console.error('Error during fetch:', error);
        });
      }




      


      //end
    </script>
  </body>
</html>
